根据您的建议，我来设计一个完善的路由策略修改方案：

  路由策略完善方案

  1. 核心路由规则重新设计

  API接口优先处理（保持不变）：
  - ✅ 有明确站点/城市名称的查询
  - ✅ 有明确时间范围的统计报表
  - ✅ 同期对比分析
  - ✅ 达标率、排名等已知范围的查询

  强制SQL查询处理（新增规则）：
  - 🔍 开放式分析查询：
    - "哪个站点PM2.5最高"
    - "排名最后的城市"
    - "超标最严重的区域"
    - "污染物浓度最大值查询"
  - 🔍 条件筛选查询：
    - "PM2.5超过100的站点"
    - "AQI大于200的城市"
    - "连续超标的时间段"
  - 🔍 聚合计算查询：
    - "平均浓度计算"
    - "自定义时间段统计"
    - "复杂JOIN查询"

  2. 修改点详细说明

  A. 意图分类器增强（src/uqp_router.py）

  # 新增开放式查询识别关键词
  OPEN_ANALYSIS_KEYWORDS = [
      "最高", "最低", "最大", "最小", "排名最后", "排名第一",
      "哪个", "哪些", "超过", "大于", "小于", "超标",
      "平均", "总计", "统计", "分析", "对比所有"
  ]

  B. 外部API处理器修改（src/external_api_handler.py）

  - 在工具选择前添加开放式查询检测
  - 检测到开放式查询直接返回降级指令

  C. VannaService集成（src/vanna_service.py）

  - 增加开放式查询的SQL模板优化
  - 添加专门的提示词处理开放式分析

  D. 配置文件更新（config/config.yaml）

  routing_strategy:
    open_analysis_detection: true
    force_sql_keywords: ["最高", "最低", "哪个", "超过", "大于"]
    api_priority_enabled: true

  3. 实现步骤

  1. 步骤1: 更新意图分类器，添加开放式查询检测
  2. 步骤2: 修改外部API处理器，增加查询类型预检测
  3. 步骤3: 优化VannaService的SQL生成能力
  4. 步骤4: 更新配置文件和文档
  5. 步骤5: 添加测试用例验证路由正确性

  4. 预期效果

  - ✅ 明确查询：继续通过API接口获得高质量数据
  - ✅ 开放式查询：自动路由到SQL，避免批量API调用
  - ✅ 智能判断：系统自动识别查询类型并选择最佳路由
  - ✅ 性能优化：减少不必要的API调用，提升响应速度